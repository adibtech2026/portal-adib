<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIB TECH - PAINEL OPERACIONAL</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        :root { --azul: #00263e; --ouro: #c5a059; --bg: #f4f7f6; --danger: #dc3545; }
        body { display: flex; background: var(--bg); min-height: 100vh; }
        .sidebar { width: 260px; background: var(--azul); color: white; position: fixed; height: 100%; display: flex; flex-direction: column; z-index: 1000; }
        .brand { padding: 25px 20px; text-align: center; background: white; border-bottom: 3px solid var(--ouro); }
        .brand img { max-width: 100%; height: auto; }
        .unit-selector { padding: 20px; background: #003659; border-bottom: 1px solid #004a7a; }
        .unit-selector label { font-size: 10px; color: var(--ouro); font-weight: bold; display: block; margin-bottom: 8px; }
        .unit-selector select { width: 100%; background: #001a2b; color: white; border: 1px solid var(--ouro); padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .main-content { margin-left: 260px; flex-grow: 1; padding: 40px; }
        header { background: white; padding: 18px 40px; margin: -40px -40px 40px -40px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .status { font-size: 11px; font-weight: bold; }
        .card { background: white; padding: 25px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .search-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; outline: none; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; background: #f8f9fa; color: var(--azul); font-size: 10px; text-transform: uppercase; border-bottom: 2px solid var(--ouro); }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .badge-zero { background: var(--danger); color: white; padding: 4px 8px; border-radius: 3px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand">
            <img src="https://github.com/adibtech2026/Gestaodepuxada/blob/main/Logo%20Marca%20Vetorizada%20-%20Adib%20+%20AB%20in%20Bev%202025.png?raw=true" alt="Adib">
        </div>
        <div class="unit-selector">
            <label>FILIAL ATUAL</label>
            <select id="select-unidade" onchange="carregarDados()">
                <option value="Sede">Sede</option>
                <option value="Vera Cruz">Filial Vera Cruz</option>
                <option value="Morro">Filial Morro de São Paulo</option>
            </select>
        </div>
    </div>

    <div class="main-content">
        <header>
            <span class="status" id="status-label" style="color: orange;">● CONECTANDO...</span>
            <button onclick="carregarDados()" style="background:none; border:none; color:var(--ouro); cursor:pointer; font-size:11px; font-weight:bold;">🔄 ATUALIZAR AGORA</button>
        </header>

        <div class="card">
            <h3 id="txt-unidade" style="margin-bottom: 15px;">Estoque Online</h3>
            <input type="text" id="filtro" class="search-box" onkeyup="filtrar()" placeholder="Procurar produto ou código...">
            <table>
                <thead>
                    <tr>
                        <th>Cód</th>
                        <th>Descrição</th>
                        <th>Inic.</th>
                        <th>Ent.</th>
                        <th>Saídas</th>
                        <th>Disp.</th>
                    </tr>
                </thead>
                <tbody id="tabela-corpo">
                    <tr><td colspan="6" style="text-align:center; padding:50px;">Carregando dados da Planilha...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SHEET_ID = '1IhsAvFRdMk3TV8JdqFnj0CwRErl8msZuslrSi6QMFnE';

        async function carregarDados() {
            const unidade = document.getElementById('select-unidade').value;
            const statusLabel = document.getElementById('status-label');
            const tabela = document.getElementById('tabela-corpo');
            
            statusLabel.innerText = "● SINCRONIZANDO...";
            statusLabel.style.color = "orange";

            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(unidade)}`;

            try {
                const response = await fetch(url);
                const text = await response.text();
                const jsonText = text.match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/);
                const data = JSON.parse(jsonText[1]);
                const cols = data.table.cols; // Cabeçalhos do Google
                const rows = data.table.rows; // Dados
                
                // Mapeamento automático por nome de coluna
                const mapa = {};
                cols.forEach((col, idx) => {
                    if (col.label) {
                        const nome = col.label.toLowerCase().replace('.', '').trim();
                        mapa[nome] = idx;
                    }
                });

                let html = "";
                
                rows.forEach((row) => {
                    const c = row.c;
                    if (!c) return;

                    const getVal = (label) => {
                        const idx = mapa[label.toLowerCase().replace('.', '').trim()];
                        if (idx === undefined || !c[idx]) return "0";
                        return c[idx].f ? c[idx].f : (c[idx].v !== null ? String(c[idx].v) : "0");
                    };
                    
                    const codOriginal = getVal("Cod");
                    const desc = getVal("Descricao");

                    // Pula se for a linha de título
                    if (codOriginal === "Cod" || codOriginal === "Grade" || !desc || desc === "Descricao") return;

                    const cod   = codOriginal.replace(/^0+/, ''); 
                    const inic  = getVal("Inicial");
                    const ent   = getVal("Ent");
                    const sai   = getVal("Saidas");
                    const disp  = getVal("Disp");
                    const dispNum = parseFloat(String(disp).replace(',', '.')) || 0;

                    html += `
                        <tr style="${dispNum <= 0 ? 'background:#fff5f5' : ''}">
                            <td>${cod}</td>
                            <td>${desc}</td>
                            <td>${inic}</td>
                            <td>${ent}</td>
                            <td>${sai}</td>
                            <td><span class="${dispNum <= 0 ? 'badge-zero' : ''}">${disp}</span></td>
                        </tr>`;
                });

                tabela.innerHTML = html || "<tr><td colspan='6' style='text-align:center;'>Nenhum dado encontrado. Verifique os títulos da primeira linha.</td></tr>";
                statusLabel.innerText = "● CONECTADO";
                statusLabel.style.color = "#27ae60";
                document.getElementById('txt-unidade').innerText = "Estoque: " + unidade;

            } catch (error) {
                console.error(error);
                statusLabel.innerText = "● ERRO DE FORMATO";
                statusLabel.style.color = "red";
                tabela.innerHTML = "<tr><td colspan='6' style='text-align:center;'>Erro ao ler colunas. Use: Cod, Descricao, Inicial, Ent., Saidas, Disp. na linha 1.</td></tr>";
            }
        }

        function filtrar() {
            const val = document.getElementById('filtro').value.toLowerCase();
            document.querySelectorAll('#tabela-corpo tr').forEach(tr => {
                tr.style.display = tr.innerText.toLowerCase().includes(val) ? "" : "none";
            });
        }

        window.onload = carregarDados;
    </script>
</body>
</html>