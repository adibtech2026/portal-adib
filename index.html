<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADIB TECH - GEST√ÉO INTEGRADA</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        :root {
            --bg-principal: #f4f7f6; 
            --azul-escuro: #00263e;   
            --dourado: #c5a059;       
            --danger: #dc3545;
            --warning: #ffc107;
            --success: #28a745;
        }
        body { display: flex; background: var(--bg-principal); min-height: 100vh; }
        .sidebar { width: 260px; background: var(--azul-escuro); color: #ecf0f1; position: fixed; height: 100%; display: flex; flex-direction: column; z-index: 1000; }
        .brand { padding: 25px 20px; text-align: center; background: white; border-bottom: 3px solid var(--dourado); }
        .brand img { max-width: 100%; height: auto; }
        .unit-selector { padding: 20px; background: #003659; }
        .unit-selector select { width: 100%; background: #001a2b; color: white; border: 1px solid var(--dourado); padding: 10px; border-radius: 4px; cursor: pointer; }
        .nav-menu { flex-grow: 1; padding-top: 15px; }
        .nav-item { padding: 18px 25px; cursor: pointer; font-size: 11px; text-transform: uppercase; font-weight: bold; border-left: 4px solid transparent; opacity: 0.7; }
        .nav-item.active { opacity: 1; background: #003659; border-left: 4px solid var(--dourado); }
        .main-content { margin-left: 260px; flex-grow: 1; padding: 40px; }
        header { background: white; padding: 18px 40px; margin: -40px -40px 40px -40px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; }
        .kpi-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .kpi-card { background: white; padding: 15px; border-radius: 4px; flex: 1; border-left: 4px solid var(--dourado); box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .kpi-card div { font-size: 20px; font-weight: bold; }
        .aba { display: none; } .aba.active { display: block; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { text-align: left; padding: 12px; background: #f8f9fa; font-size: 10px; text-transform: uppercase; border-bottom: 2px solid var(--dourado); }
        td { padding: 10px 12px; border-bottom: 1px solid #eee; font-size: 13px; }
        .badge { padding: 4px 8px; border-radius: 3px; font-weight: bold; font-size: 11px; color: white; }
        .bg-danger { background: var(--danger); } .bg-warning { background: var(--warning); color: #000; } .bg-success { background: var(--success); }
    </style>
</head>
<body>

    <div class="sidebar">
        <div class="brand"><img src="https://github.com/adibtech2026/Gestaodepuxada/blob/main/Logo%20Marca%20Vetorizada%20-%20Adib%20+%20AB%20in%20Bev%202025.png?raw=true" alt="Adib"></div>
        <div class="unit-selector">
            <select id="select-unidade" onchange="trocarUnidade()">
                <option value="Sede">Sede</option>
                <option value="Vera Cruz">Filial Vera Cruz</option>
                <option value="Morro">Filial Morro de S√£o Paulo</option>
            </select>
        </div>
        <div class="nav-menu">
            <div class="nav-item active" onclick="navegar('estoque-online', this)">Estoque Online</div>
            <div class="nav-item" onclick="navegar('validades', this)">‚ö†Ô∏è Alerta de Validades</div>
        </div>
    </div>

    <div class="main-content">
        <header>
            <span id="sync-label" style="font-size: 11px; font-weight: bold; color: orange;">‚óè SINCRONIZANDO...</span>
            <button onclick="carregarTudo()" style="cursor:pointer; background:none; border:1px solid var(--dourado); color:var(--dourado); font-size:10px; padding:5px;">üîÑ ATUALIZAR</button>
        </header>

        <div class="kpi-container">
            <div class="kpi-card"><small>Zerados</small><div id="kpi-zerados">0</div></div>
            <div class="kpi-card" style="border-left-color: var(--danger);"><small>Urgente < 30d</small><div id="kpi-urgente">0</div></div>
            <div class="kpi-card" style="border-left-color: var(--warning);"><small>Aten√ß√£o < 60d</small><div id="kpi-atencao">0</div></div>
        </div>

        <section id="aba-estoque-online" class="aba active">
            <div class="card">
                <table>
                    <thead><tr><th>C√≥d</th><th>Descri√ß√£o</th><th>Inic.</th><th>Ent.</th><th>Sa√≠das</th><th>Disp.</th></tr></thead>
                    <tbody id="corpo-estoque"></tbody>
                </table>
            </div>
        </section>

        <section id="aba-validades" class="aba">
            <div class="card">
                <table>
                    <thead><tr><th>C√≥d</th><th>Produto</th><th>Vencimento</th><th>Qtd Lote</th><th>Status</th></tr></thead>
                    <tbody id="corpo-validades"></tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const SHEET_ID = '1IhsAvFRdMk3TV8JdqFnj0CwRErl8msZuslrSi6QMFnE';
        let unidadeAtual = "Sede";

        function navegar(id, el) {
            document.querySelectorAll('.aba').forEach(a => a.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('aba-'+id).classList.add('active');
            el.classList.add('active');
        }

        function trocarUnidade() {
            unidadeAtual = document.getElementById('select-unidade').value;
            carregarTudo();
        }

        async function carregarTudo() {
            const label = document.getElementById('sync-label');
            label.innerText = "‚óè SINCRONIZANDO..."; label.style.color = "orange";
            try {
                const resEst = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(unidadeAtual)}`);
                const jsonEst = JSON.parse((await resEst.text()).match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/)[1]);
                
                const resVal = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Validades`);
                const jsonVal = JSON.parse((await resVal.text()).match(/google\.visualization\.Query\.setResponse\(([\s\S\w]+)\)/)[1]);

                renderEstoque(jsonEst.table);
                renderValidades(jsonVal.table);

                label.innerText = "‚óè CONECTADO"; label.style.color = "#27ae60";
            } catch (e) { label.innerText = "‚óè ERRO"; label.style.color = "red"; }
        }

        function renderEstoque(table) {
            const corpo = document.getElementById('corpo-estoque'); corpo.innerHTML = "";
            let zerados = 0;
            const mapa = {}; table.cols.forEach((c,i) => { if(c.label) mapa[c.label.toLowerCase().trim()] = i; });
            
            table.rows.forEach(r => {
                const get = (l) => (mapa[l]!==undefined && r.c[mapa[l]]) ? (r.c[mapa[l]].f || String(r.c[mapa[l]].v)) : "0";
                const cod = get("cod").replace(/^0+/, '');
                if(cod === "Cod" || cod === "Grade") return;
                const disp = get("disp");
                const n = parseFloat(disp.replace(',','.')) || 0;
                if(n<=0) zerados++;
                corpo.innerHTML += `<tr style="${n<=0?'background:#fff5f5':''}"><td>${cod}</td><td>${get("descricao")}</td><td>${get("inicial")}</td><td>${get("ent")}</td><td>${get("saidas")}</td><td><span class="badge ${n<=0?'bg-danger':'bg-success'}">${disp}</span></td></tr>`;
            });
            document.getElementById('kpi-zerados').innerText = zerados;
        }

        function renderValidades(table) {
            const corpo = document.getElementById('corpo-validades'); corpo.innerHTML = "";
            const hoje = new Date();
            let urg = 0, atn = 0;
            const mapa = {}; table.cols.forEach((c,i) => { if(c.label) mapa[c.label.toLowerCase().trim()] = i; });

            table.rows.forEach((r, idx) => {
                if(idx === 0) return;
                const get = (l) => (mapa[l]!==undefined && r.c[mapa[l]]) ? r.c[mapa[l]] : null;
                
                const colData = get("data");
                if(!colData) return;

                let dtObj = colData.v;
                if(typeof dtObj === 'string' && dtObj.includes('Date')) dtObj = eval("new " + dtObj);
                else dtObj = new Date(dtObj);

                const dias = Math.ceil((dtObj - hoje) / (1000*60*60*24));
                const dataBR = colData.f || dtObj.toLocaleDateString('pt-BR');
                const cod = get("cod") ? String(get("cod").v).replace(/^0+/, '') : "";
                const prod = get("produto") ? get("produto").v : "";
                const qtd = get("qtd") ? (get("qtd").f || get("qtd").v) : "0";

                let cl = "", cb = "bg-success", st = "SEGURO";
                if(dias <= 30) { cl="row-critico"; cb="bg-danger"; st="URGENTE"; urg++; }
                else if(dias <= 60) { cl="row-alerta"; cb="bg-warning"; st="ATEN√á√ÉO"; atn++; }
                
                corpo.innerHTML += `<tr class="${cl}"><td>${cod}</td><td>${prod}</td><td>${dataBR}</td><td>${qtd}</td><td><span class="badge ${cb}">${st}</span></td></tr>`;
            });

            document.getElementById('kpi-urgente').innerText = urg;
            document.getElementById('kpi-atencao').innerText = atn;
        }

        window.onload = carregarTudo;
    </script>
</body>
</html>
